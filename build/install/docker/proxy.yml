version: "3.8"
x-healthcheck:
  &x-healthcheck
  test: curl --fail http://127.0.0.1 || exit 1
  interval: 60s
  retries: 5
  start_period: 20s
  timeout: 10s

services:
  onlyoffice-proxy:
    image: nginx
    container_name: ${PROXY_HOST}
    restart: always
    healthcheck:
     <<: *x-healthcheck
     test: nginx -t || exit 1
    ports:
      - ${EXTERNAL_PORT}:80
    environment:
      - ROUTER_HOST=${ROUTER_HOST}
    volumes:
      - webroot_path:/letsencrypt
      - proxy_log:/var/log/nginx
      - ./config/nginx/templates/nginx.conf.template:/etc/nginx/nginx.conf
      - ./config/nginx/letsencrypt.conf:/etc/nginx/includes/letsencrypt.conf
      - ./config/nginx/templates/proxy.upstream.conf.template:/etc/nginx/templates/proxy.upstream.conf.template:ro
      - ./config/nginx/onlyoffice-proxy.conf:/etc/nginx/conf.d/default.conf

networks:
  default:
    name: ${NETWORK_NAME}
    external: true

volumes:
  proxy_log:
  webroot_path:
