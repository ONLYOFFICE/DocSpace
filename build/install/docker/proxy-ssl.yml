version: "3.8"
x-healthcheck:
  &x-healthcheck
  test: curl --fail http://127.0.0.1 || exit 1
  interval: 60s
  retries: 5
  start_period: 20s
  timeout: 10s

services:
  onlyoffice-proxy:
    image: nginx
    container_name: ${PROXY_HOST}
    restart: always
    healthcheck:
     <<: *x-healthcheck
     test: nginx -t || exit 1
    ports:
      - 80:80
      - 443:443
    environment:
      - ROUTER_HOST=${ROUTER_HOST}
    volumes:
      - proxy_log:/var/log/nginx
      - ./config/nginx/templates/nginx.conf.template:/etc/nginx/nginx.conf
      - ./config/nginx/templates/proxy.upstream.conf.template:/etc/nginx/templates/proxy.upstream.conf.template:ro
      - ./config/nginx/onlyoffice-proxy-ssl.conf:/etc/nginx/conf.d/default.conf
      - ${CERTIFICATE_PATH}:/usr/local/share/ca-certificates/tls.crt
      - ${CERTIFICATE_KEY_PATH}:/etc/ssl/private/tls.key
      - ${DHPARAM_PATH}:/etc/ssl/certs/dhparam.pem

networks:
  default:
    name: ${NETWORK_NAME}
    external: true

volumes:
  proxy_log:
