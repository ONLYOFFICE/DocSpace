name: Release RPM DEB
on:
  push: 
      tags: 
        - '*'

jobs:

  create_relese:
    name: Create release 
    runs-on: ubuntu-latest
    permissions:
        contents: write
    steps: 
      - name: Create release
        uses: softprops/action-gh-release@v1
        with:
          token: "${{ secrets.GITHUB_TOKEN }}"
          name: Release v-${{ github.run_number }}
          tag_name: "${{ github.event.release.tag_name }}"
          body: |
            Release packages for ONLYOFFICE DocSpace:           
            - .deb
            - .rpm
          draft: false
  

  build_deb:
    name: Build .deb package
    runs-on: ubuntu-latest
    permissions:
      contents: write
      
    steps:
      - name: Get files from repository
        uses: actions/checkout@v2
        
      - name: INSTALL tools & Prepare build /home/runner/work/DocSpace/DocSpace
        run: |
          sudo apt install -y dh-make nginx mysql-server rename curl
          curl -sS https://dl.yarnpkg.com/debian/pubkey.gpg | sudo apt-key add -
          echo "deb https://dl.yarnpkg.com/debian/ stable main" | sudo tee /etc/apt/sources.list.d/yarn.list
          sudo apt-get remove libnode72
          sudo apt-get clean
          curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
          declare repo_version=$(if command -v lsb_release &> /dev/null; then lsb_release -r -s; else grep -oP '(?<=^VERSION_ID=).+' /etc/os-release | tr -d '"'; fi)
          wget https://packages.microsoft.com/config/ubuntu/$repo_version/packages-microsoft-prod.deb -O packages-microsoft-prod.deb
          sudo dpkg -i packages-microsoft-prod.deb
          sudo apt update
          sudo apt install -y dotnet-sdk-7.0 yarn nodejs
          sudo npm install -g json
          
      - name: BUILD package DEB
        run: |
          dotnet --version
          pwd && ls -la
          # cd build/install/deb/debian
          cat << EOF >> build-DocSpace_deb.sh
          set -x
          PRODUCT_11="docspace"
          TAG="1.0.0"
          BUILD_NUMBER="999"
          sudo sed -i "s_Duplicates)' == 'false'_Duplicates)' == 'true'_" /usr/share/dotnet/sdk/$(dotnet --version)/Sdks/Microsoft.NET.Sdk/targets/Microsoft.NET.ConflictResolution.targets  
          cd build/install/deb
          pwd
          rename -f -v "s/product([^\/]*)$/$PRODUCT\$1/g" debian/* ../common/* ../common/logrotate
          # rename -f -v "s/product([^\/]*)$/${PRODUCT_11}\$1/g" debian/* ../common/* ../common/logrotate/* 
          sudo find ../ -type f -exec sed -i "s/{{product}}/${PRODUCT_11}/g" {} ';'
          sudo sed -i "s/{{package_header_tag_version}}/${TAG}.${BUILD_NUMBER}/g" debian/changelog debian/control 
          dpkg-buildpackage -us -uc
          EOF
          chmod +x build-DocSpace_deb.sh
          sudo bash ./build-DocSpace_deb.sh
        shell: bash

      - name: Upload assets DEB
        uses: softprops/action-gh-release@v1
        with:
          files: /home/runner/DocSpace/DocSpace/build/install/deb/debian/*.deb
          

  build_rpm:
    name: Build .rpm package
    runs-on: ubuntu-latest
    permissions:
      contents: write
 
    steps:
      - name: Get files from repository.
        uses: actions/checkout@v2
        
      - name: INSTALL tools & Prepare build
        run: |
          sudo apt install -y rpm nginx mysql-server rename curl
          curl -sS https://dl.yarnpkg.com/debian/pubkey.gpg | sudo apt-key add -
          echo "deb https://dl.yarnpkg.com/debian/ stable main" | sudo tee /etc/apt/sources.list.d/yarn.list
          sudo apt-get remove libnode72
          sudo apt-get clean
          curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
          declare repo_version=$(if command -v lsb_release &> /dev/null; then lsb_release -r -s; else grep -oP '(?<=^VERSION_ID=).+' /etc/os-release | tr -d '"'; fi)
          wget https://packages.microsoft.com/config/ubuntu/$repo_version/packages-microsoft-prod.deb -O packages-microsoft-prod.deb
          sudo dpkg -i packages-microsoft-prod.deb
          sudo apt update
          sudo apt install -y dotnet-sdk-7.0 yarn nodejs
          sudo npm install -g json
          
        
    
      - name: BUILD package RPM
        run: |
          cd build/install/rpm/SPECS
          mv ./SOURCES/product.rpmlintrc ./SOURCES/docspace.rpmlintrc
          
          wget https://github.com/ONLYOFFICE/docspace/archive/release/v1.0.0.tar.gz -O DocSpace-release-v1.0.0.tar.gz
          wget https://github.com/ONLYOFFICE/document-templates/archive/main/community-server.tar.gz -O document-templates-main-community-server.tar.gz
          wget https://github.com/ONLYOFFICE/dictionaries/archive/master.tar.gz -O dictionaries-master.tar.gz
          cp *.tar.gz ./SOURCES
          
          cat << EOF >> build-DocSpace_rpm.sh
          set -x
          sed -i -e '/BuildRequires/d' product.spec
          GIT_BRANCH=release
          rename 's/product/docspace/g' ../../common/*.sh
          rpmbuild -D "GIT_BRANCH release-v1.0.0" -D "_topdir $(pwd)" -D "version 1.0.0" -D "release 999" -ba product.spec
          EOF
          
          chmod +x build-DocSpace_rpm.sh
          sudo bash ./build-DocSpace_rpm.sh
          
        
        
      - name: Upload assets RPM /home/runner/work/DocSpace/DocSpace
        uses: softprops/action-gh-release@v1
        with:
          files: /home/runner/work/DocSpace/DocSpace/build/install/rpm/SPECS/RPMS/x86_64/*.rpm
